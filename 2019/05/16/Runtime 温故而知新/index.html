<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-flash.min.css?v=1.0.2">















  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-medium.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-small.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Runtimeæœ¬æ–‡åŸºäº runtime çš„æœ€æ–°ç‰ˆæœ¬ 750ï¼Œæºç å¯ä»¥ç‚¹è¿™é‡Œä¸‹è½½ï¼Œå¯ç¼–è¯‘ç‰ˆæœ¬å¯ä»¥ç‚¹è¿™é‡Œä¸‹è½½ã€‚">
<meta name="keywords" content="Runtime">
<meta property="og:type" content="article">
<meta property="og:title" content="Runtime æ¸©æ•…è€ŒçŸ¥æ–°">
<meta property="og:url" content="https://iCodeWoods.github.io/2019/05/16/Runtime æ¸©æ•…è€ŒçŸ¥æ–°/index.html">
<meta property="og:site_name" content="iCodeWoodsçš„å°ç«™">
<meta property="og:description" content="Runtimeæœ¬æ–‡åŸºäº runtime çš„æœ€æ–°ç‰ˆæœ¬ 750ï¼Œæºç å¯ä»¥ç‚¹è¿™é‡Œä¸‹è½½ï¼Œå¯ç¼–è¯‘ç‰ˆæœ¬å¯ä»¥ç‚¹è¿™é‡Œä¸‹è½½ã€‚">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://icodewoods.github.io/2019/05/16/Runtime%20æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Breakpoint_Load.png">
<meta property="og:image" content="https://icodewoods.github.io/2019/05/16/Runtime%20æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Product_Exec.png">
<meta property="og:image" content="https://icodewoods.github.io/2019/05/16/Runtime%20æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_MachOView_NonLazyClass.png">
<meta property="og:image" content="https://icodewoods.github.io/2019/05/16/Runtime%20æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Hopper_XXObject.png">
<meta property="og:image" content="https://icodewoods.github.io/2019/05/16/Runtime%20æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Breakpoint_LoadImages.png">
<meta property="og:image" content="https://icodewoods.github.io/2019/05/16/Runtime%20æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_PrintOption_PrintImageTimes.png">
<meta property="og:image" content="https://icodewoods.github.io/2019/05/16/Runtime%20æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Process.png">
<meta property="og:updated_time" content="2019-10-09T02:24:18.616Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Runtime æ¸©æ•…è€ŒçŸ¥æ–°">
<meta name="twitter:description" content="Runtimeæœ¬æ–‡åŸºäº runtime çš„æœ€æ–°ç‰ˆæœ¬ 750ï¼Œæºç å¯ä»¥ç‚¹è¿™é‡Œä¸‹è½½ï¼Œå¯ç¼–è¯‘ç‰ˆæœ¬å¯ä»¥ç‚¹è¿™é‡Œä¸‹è½½ã€‚">
<meta name="twitter:image" content="https://icodewoods.github.io/2019/05/16/Runtime%20æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Breakpoint_Load.png">





  
  
  <link rel="canonical" href="https://iCodeWoods.github.io/2019/05/16/Runtime æ¸©æ•…è€ŒçŸ¥æ–°/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Runtime æ¸©æ•…è€ŒçŸ¥æ–° | iCodeWoodsçš„å°ç«™</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">iCodeWoodsçš„å°ç«™</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">ç‰‡åˆ»ä¹‹æ¬¢æ„‰ï¼Œä¸å¦‚é¡»è‡¾ä¹‹å®é™</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>é¦–é¡µ</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>æ ‡ç­¾</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>åˆ†ç±»</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>å½’æ¡£</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>å…³äº</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://iCodeWoods.github.io/2019/05/16/Runtime æ¸©æ•…è€ŒçŸ¥æ–°/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="iCodeWoods">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="iCodeWoodsçš„å°ç«™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Runtime æ¸©æ•…è€ŒçŸ¥æ–°

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-05-16 15:51:00" itemprop="dateCreated datePublished" datetime="2019-05-16T15:51:00+08:00">2019-05-16</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             é˜…è¯»æ¬¡æ•°ï¼š 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h1><p>æœ¬æ–‡åŸºäº runtime çš„æœ€æ–°ç‰ˆæœ¬ 750ï¼Œæºç å¯ä»¥<a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">ç‚¹è¿™é‡Œ</a>ä¸‹è½½ï¼Œå¯ç¼–è¯‘ç‰ˆæœ¬å¯ä»¥<a href="https://github.com/RetVal/objc-runtime" target="_blank" rel="noopener">ç‚¹è¿™é‡Œ</a>ä¸‹è½½ã€‚</p>
<a id="more"></a>
<h2 id="load"><a href="#load" class="headerlink" title="+ load"></a>+ load</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// main.m</span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">@interface XXObject : NSObject</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation XXObject</span><br><span class="line"></span><br><span class="line">+ (void)load &#123;</span><br><span class="line">	NSLog(@&quot;XXObject load&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        NSLog(@&quot;Hello, World!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ–­ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è°ƒç”¨æ ˆï¼š</p>
<p><img src="/2019/05/16/Runtime æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Breakpoint_Load.png" alt="Runtime_Breakpoint_Load"></p>
<h3 id="load-images"><a href="#load-images" class="headerlink" title="load_images"></a>load_images</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.mm</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">load_images(<span class="keyword">const</span> <span class="keyword">char</span> *path __unused, <span class="keyword">const</span> struct mach_header *mh)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Return without taking locks if there are no +load methods here.</span></span><br><span class="line">    <span class="keyword">if</span> (!hasLoadMethods((<span class="keyword">const</span> headerType *)mh)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">recursive_mutex_locker_t</span> lock(loadMethodLock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Discover load methods</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">mutex_locker_t</span> lock2(runtimeLock);</span><br><span class="line">        prepare_load_methods((<span class="keyword">const</span> headerType *)mh);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call +load methods (without runtimeLock - re-entrant)</span></span><br><span class="line">    call_load_methods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç éå¸¸æ¸…æ™°ï¼š</p>
<ol>
<li><code>hasLoadMethods</code>ï¼šé€šè¿‡ <code>mach_header</code> åˆ¤æ–­é•œåƒä¸­æ˜¯å¦æœ‰ load æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ç›´æ¥è¿”å›</li>
<li><code>prepare_load_methods</code>ï¼šå‡†å¤‡å¥½ load æ–¹æ³•</li>
<li><code>call_load_methods</code>ï¼šè°ƒç”¨ load æ–¹æ³•</li>
</ol>
<blockquote>
<p>PSï¼šmach_header æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œé‡Œé¢è®°å½•äº†é•œåƒçš„ä¸€äº›ä¿¡æ¯ã€‚headerType åœ¨é 64 ä½ä¸‹å°±æ˜¯ mach_headerï¼Œåœ¨ 64 ä½ä¸‹æ˜¯ mach_header_64</p>
</blockquote>
<p>é‚£ä¹ˆ <code>load_images</code> æ–¹æ³•ä¼šåŠ è½½å“ªäº›é•œåƒå‘¢ï¼Ÿæˆ‘ä»¬åœ¨ <code>hasLoadMethods</code> å¤„å¢åŠ ä¸€ä¸ªæ–­ç‚¹ï¼Œè¾“å‡º <code>path</code> ä»¥åŠæ˜¯å¦æœ‰ <code>load</code> æ–¹æ³•ï¼Œæˆªå–å…¶ä¸­ä¸€éƒ¨åˆ†è¾“å‡ºå¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">load_images... path: <span class="string">"/usr/lib/system/introspection/libdispatch.dylib"</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"></span><br><span class="line">load_images... path: <span class="string">"/usr/lib/system/libsystem_trace.dylib"</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"></span><br><span class="line">load_images... path: <span class="string">"/usr/lib/system/libxpc.dylib"</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"></span><br><span class="line">load_images... path: <span class="string">"/System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation"</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"></span><br><span class="line">load_images... path: <span class="string">"/System/Library/Frameworks/Security.framework/Versions/A/Security"</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"></span><br><span class="line">load_images... path: <span class="string">"/usr/lib/libnetwork.dylib"</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"></span><br><span class="line">load_images... path: <span class="string">"/System/Library/Frameworks/CFNetwork.framework/Versions/A/CFNetwork"</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// ...çœç•¥</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€æ­¥æ­¥åˆ†æ load_images æ‰€å¹²çš„è¿™ä¸‰ä»¶äº‹ã€‚</p>
<blockquote>
<p>æ‰©å±•é˜…è¯»ï¼šMach-OåŒ…å«ä»¥ä¸‹å‡ ç§æ–‡ä»¶ç±»å‹</p>
<ul>
<li>Executableï¼šåº”ç”¨çš„ä¸»è¦äºŒè¿›åˆ¶</li>
<li>Dylibï¼šåŠ¨æ€é“¾æ¥åº“</li>
<li>Bundleï¼šä¸èƒ½è¢«é“¾æ¥ï¼Œåªèƒ½åœ¨è¿è¡Œæ—¶ä½¿ç”¨dlopenåŠ è½½</li>
<li>Imageï¼šåŒ…å« Executableã€Dylib å’Œ Bundle</li>
<li>Frameworkï¼šåŒ…å«Dylibã€èµ„æºæ–‡ä»¶å’Œå¤´æ–‡ä»¶çš„æ–‡ä»¶å¤¹</li>
</ul>
</blockquote>
<h4 id="hasLoadMethods"><a href="#hasLoadMethods" class="headerlink" title="hasLoadMethods"></a>hasLoadMethods</h4><p>ç¬¬ä¸€æ­¥ï¼Œå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªé•œåƒä¸­æ˜¯å¦æœ‰ <code>load</code> æ–¹æ³•ï¼Ÿå…¶å®å°±æ˜¯æŸ¥æ‰¾è¯¥é•œåƒä¸­æ˜¯å¦æœ‰â€œéæ‡’åŠ è½½çš„ç±»â€ï¼ˆNonlazyClassï¼‰æˆ–â€œéæ‡’åŠ è½½çš„åˆ†ç±»â€ï¼ˆNonlazyCategoryï¼‰ã€‚ç»“åˆè¿™ä¸ªæ–¹æ³•çš„æ–¹æ³•åï¼Œå°±å¾ˆå®¹æ˜“è¿™ä¸¤ä¸ªæ¦‚å¿µäº†â€”â€”æœ‰ <code>+ load</code> æ–¹æ³•çš„ç±»/åˆ†ç±»å°±æ˜¯â€œéæ‡’åŠ è½½çš„â€ï¼Œæ²¡æœ‰ <code>+ load</code> æ–¹æ³•çš„ç±»/åˆ†ç±»å°±æ˜¯æ‡’åŠ è½½çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.mm</span></span><br><span class="line"><span class="comment">// Quick scan for +load methods that doesn't take a lock.</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">hasLoadMethods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">    <span class="keyword">if</span> (_getObjc2NonlazyClassList(mhdr, &amp;count)  &amp;&amp;  count &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (_getObjc2NonlazyCategoryList(mhdr, &amp;count)  &amp;&amp;  count &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getObjc2NonlazyClassList"><a href="#getObjc2NonlazyClassList" class="headerlink" title="_getObjc2NonlazyClassList"></a>_getObjc2NonlazyClassList</h5><p>é‚£ä¹ˆå¦‚ä½•è·å–é•œåƒä¸­çš„ NonlazyClassList/NonlazyCategoryList å‘¢ï¼Ÿæˆ‘ä»¬è·³è½¬åˆ° <code>_getObjc2NonlazyClassList</code> çš„å®šä¹‰ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// object-file.mm</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GETSECT(name, type, sectname)                                   \</span></span><br><span class="line">    <span class="function">type *<span class="title">name</span><span class="params">(<span class="keyword">const</span> headerType *mhdr, <span class="keyword">size_t</span> *outCount)</span> </span>&#123;              \</span><br><span class="line">        <span class="keyword">return</span> getDataSection&lt;type&gt;(mhdr, sectname, nil, outCount);     \</span><br><span class="line">    &#125;                                                                   \</span><br><span class="line">    <span class="function">type *<span class="title">name</span><span class="params">(<span class="keyword">const</span> header_info *hi, <span class="keyword">size_t</span> *outCount)</span> </span>&#123;               \</span><br><span class="line">        <span class="keyword">return</span> getDataSection&lt;type&gt;(hi-&gt;mhdr(), sectname, nil, outCount); \</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//      function name                 content type     section name</span></span><br><span class="line">GETSECT(_getObjc2SelectorRefs,        SEL,             <span class="string">"__objc_selrefs"</span>); </span><br><span class="line">GETSECT(_getObjc2MessageRefs,         <span class="keyword">message_ref_t</span>,   <span class="string">"__objc_msgrefs"</span>); </span><br><span class="line">GETSECT(_getObjc2ClassRefs,           Class,           <span class="string">"__objc_classrefs"</span>);</span><br><span class="line">GETSECT(_getObjc2SuperRefs,           Class,           <span class="string">"__objc_superrefs"</span>);</span><br><span class="line">GETSECT(_getObjc2ClassList,           <span class="keyword">classref_t</span>,      <span class="string">"__objc_classlist"</span>);</span><br><span class="line">GETSECT(_getObjc2NonlazyClassList,    <span class="keyword">classref_t</span>,      <span class="string">"__objc_nlclslist"</span>);</span><br><span class="line">GETSECT(_getObjc2CategoryList,        <span class="keyword">category_t</span> *,    <span class="string">"__objc_catlist"</span>);</span><br><span class="line">GETSECT(_getObjc2NonlazyCategoryList, <span class="keyword">category_t</span> *,    <span class="string">"__objc_nlcatlist"</span>);</span><br><span class="line">GETSECT(_getObjc2ProtocolList,        <span class="keyword">protocol_t</span> *,    <span class="string">"__objc_protolist"</span>);</span><br><span class="line">GETSECT(_getObjc2ProtocolRefs,        <span class="keyword">protocol_t</span> *,    <span class="string">"__objc_protorefs"</span>);</span><br><span class="line">GETSECT(getLibobjcInitializers,       UnsignedInitializer, <span class="string">"__objc_init_func"</span>);</span><br></pre></td></tr></table></figure>
<p>ä¹ä¸€çœ‹æœ‰ç‚¹æ‡µï¼Œå…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯ ğŸ å·¥ç¨‹å¸ˆä¸ºäº† <del>å·æ‡’</del> ç®€æ´ï¼Œå®šä¹‰äº†ä¸€ä¸ªå®æ¥æ‰¹é‡å®ç°æ–¹æ³•ï¼Œå¥½æ¯”ä¸€ä¸ªæ¨¡æ¿ã€‚</p>
<p>ä¸¾ä¸ªğŸŒ°ï¼Œå¯¹äº <code>_getObjc2NonlazyClassList</code> æ¥è¯´ï¼Œå…¶å®è¿™é‡Œæ˜¯å®ç°äº†ä¸¤ä¸ªæ–¹æ³•åä¸€æ ·ï¼Œä½†å‚æ•°ä¸åŒçš„æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">classref_t</span> *_getObjc2NonlazyClassList(<span class="keyword">const</span> headerType *mhdr, <span class="keyword">size_t</span> *outCount) &#123;</span><br><span class="line">    <span class="keyword">return</span> getDataSection&lt;<span class="keyword">classref_t</span>&gt;(mhdr, <span class="string">"__objc_nlclslist"</span>, nil, outCount);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">classref_t</span> *_getObjc2NonlazyClassList(<span class="keyword">const</span> header_info *hi, <span class="keyword">size_t</span> *outCount) &#123;</span><br><span class="line">    <span class="keyword">return</span> getDataSection&lt;<span class="keyword">classref_t</span>&gt;(hi-&gt;mhdr, <span class="string">"__objc_nlclslist"</span>, nil, outCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p> å…¶å®æˆ‘ç¬¬ä¸€çœ¼çœ‹è¿™æ®µä»£ç çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªç–‘é—®ï¼šä¸ºä»€ä¹ˆè¿™é‡Œå¯ä»¥å®šä¹‰ä¸¤ä¸ªæ–¹æ³•åä¸€æ ·ã€ä½†å‚æ•°ä¸ä¸€æ ·çš„æ–¹æ³•å‘¢ï¼Ÿè¦çŸ¥é“åœ¨ OC é‡Œï¼Œè¿™æ ·å¯æ˜¯ä¼šæŠ¥é”™çš„ã€‚è¿‡äº†ä¸€ä¼šæˆ‘æ‰çªç„¶æƒ³æ˜ç™½ï¼Œè¿™æ˜¯ .mm æ–‡ä»¶ï¼ŒC++ æ˜¯å¯ä»¥è¿™æ ·å¹²çš„å•Šï¼å·®ç‚¹è¢«è‡ªå·±è ¢å“­ğŸ˜‚</p>
</blockquote>
<h5 id="getDataSection"><a href="#getDataSection" class="headerlink" title="getDataSection"></a>getDataSection</h5><p>okï¼Œç°åœ¨åªå‰©ä¸‹ <code>getDataSection</code> è¿™ä¸ªæ–¹æ³•äº†ï¼šé€šè¿‡ headerTypeï¼Œè·å–é•œåƒçš„æŒ‡å®š segment çš„æŒ‡å®š section ä¸­çš„æ•°æ®ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// object-file.mm</span></span><br><span class="line"><span class="comment">// Look for a __DATA or __DATA_CONST or __DATA_DIRTY section </span></span><br><span class="line"><span class="comment">// with the given name that stores an array of T.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T* <span class="title">getDataSection</span><span class="params">(<span class="keyword">const</span> headerType *mhdr, <span class="keyword">const</span> <span class="keyword">char</span> *sectname, </span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">size_t</span> *outBytes, <span class="keyword">size_t</span> *outCount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> byteCount = <span class="number">0</span>;</span><br><span class="line">    T* data = (T*)getsectiondata(mhdr, <span class="string">"__DATA"</span>, sectname, &amp;byteCount);</span><br><span class="line">    <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">        data = (T*)getsectiondata(mhdr, <span class="string">"__DATA_CONST"</span>, sectname, &amp;byteCount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">        data = (T*)getsectiondata(mhdr, <span class="string">"__DATA_DIRTY"</span>, sectname, &amp;byteCount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (outBytes) *outBytes = byteCount;</span><br><span class="line">    <span class="keyword">if</span> (outCount) *outCount = byteCount / <span class="keyword">sizeof</span>(T);</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æ˜¯ä»¥ <code>_getObjc2NonlazyClassList</code> ä¸ºğŸŒ°ï¼Œä¼šå…ˆæŸ¥æ‰¾ <code>__DATA</code> æ®µä¸­çš„ <code>__objc_nlclslist</code> åŒºå—ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†æ‰¾ <code>__DATA_CONST</code> æ®µä¸­çš„ <code>__objc_nlclslist</code> åŒºå—ï¼Œä»¥æ­¤ç±»æ¨ã€‚å¦‚æœéƒ½æ‰¾ä¸åˆ°çš„è¯ï¼Œå°±è¯´æ˜è¿™ä¸ªé•œåƒä¸­æ²¡æœ‰ <code>NonlazyClass</code>ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ <code>+ load</code> æ–¹æ³•ã€‚</p>
<p>ä¸ºäº†éªŒè¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ demo å·¥ç¨‹çš„ Products ç›®å½•ä¸‹ï¼Œæ‰¾åˆ°å·¥ç¨‹çš„ç¼–è¯‘äº§ç‰©â€”â€”ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆdebug-objcï¼‰</p>
<p><img src="/2019/05/16/Runtime æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Product_Exec.png" alt="Runtime_Product_Exec"></p>
<p>ç„¶åæˆ‘ä»¬å°†å…¶æ‹–å…¥ <a href="https://sourceforge.net/projects/machoview/" target="_blank" rel="noopener">MachOView</a> ä¸­æŸ¥çœ‹ï¼Œåœ¨ <code>__DATA</code> æ®µçš„ <code>__objc_nlclslist</code> section ä¸­ç¡®å®åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå…¶åœ°å€ä¸º <code>0000000100001138</code>ï¼ˆå› ä¸ºæ­¤å¤„æ˜¯å¤§ç«¯åºï¼Œæˆ‘ä»¬å°†å…¶è½¬åŒ–ä¸ºå°ç«¯åºï¼‰</p>
<p><img src="/2019/05/16/Runtime æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_MachOView_NonLazyClass.png" alt="Runtime_MachOView_NonLazyClass"></p>
<p>ç„¶åæˆ‘ä»¬å°†å¯æ‰§è¡Œæ–‡ä»¶æ‹–å…¥ <a href="https://www.hopperapp.com/" target="_blank" rel="noopener">Hopper</a>ï¼Œæ‰¾åˆ° <code>0000000100001138</code> åœ°å€ä¸Šçš„æ•°æ®ï¼Œç¡®å®æ˜¯æˆ‘ä»¬æ‰€å†™çš„ <code>XXObject</code>ï¼š</p>
<p><img src="/2019/05/16/Runtime æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Hopper_XXObject.png" alt="Runtime_Hopper_XXObject"></p>
<h4 id="prepare-load-methods"><a href="#prepare-load-methods" class="headerlink" title="prepare_load_methods"></a>prepare_load_methods</h4><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯æå‰å°†éœ€è¦è°ƒç”¨ <code>load</code> æ–¹æ³•çš„ç±»å’Œåˆ†ç±»åˆ†åˆ«åŠ å…¥å¯¹åº”çš„åˆ—è¡¨ä¸­ï¼Œä»¥ä¾›æ¥ä¸‹æ¥çš„è°ƒç”¨ï¼ˆåé¢ä¼šè¯¦è¿°ï¼‰ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.mm</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_load_methods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count, i;</span><br><span class="line"></span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">classref_t</span> *classlist = _getObjc2NonlazyClassList(mhdr, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        schedule_class_load(remapClass(classlist[i]));</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">category_t</span> **categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">category_t</span> *cat = categorylist[i];</span><br><span class="line">        Class cls = remapClass(cat-&gt;cls);</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;  <span class="comment">// category for ignored weak-linked class</span></span><br><span class="line">        realizeClass(cls);</span><br><span class="line">        assert(cls-&gt;ISA()-&gt;isRealized());</span><br><span class="line">        add_category_to_loadable_list(cat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å…ˆçœ‹ç±»çš„éƒ¨åˆ†ï¼ˆä¸ºäº†æ–¹ä¾¿å¿«é€Ÿç†è§£å¤§è‡´é€»è¾‘ã€é¿å…æ··ä¹±ï¼Œæˆ‘ä»¬å…ˆæš‚æ—¶å¿½ç•¥ <code>remapClass</code>ï¼Œåé¢ä¼šè¯¦è¿°ï¼‰ã€‚</p>
<h5 id="schedule-class-load"><a href="#schedule-class-load" class="headerlink" title="schedule_class_load"></a>schedule_class_load</h5><p><code>_getObjc2NonlazyClassList</code> ä¸Šæ–‡æˆ‘ä»¬å·²ç»è§£é‡Šè¿‡äº†ã€‚è·å–å½“å‰é•œåƒçš„æ‰€æœ‰éæ‡’åŠ è½½çš„ç±»ï¼Œç„¶åè¿›è¡Œéå†ï¼Œè°ƒç”¨ <code>schedule_class_load</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.mm</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">schedule_class_load</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span>;</span><br><span class="line">    assert(cls-&gt;isRealized());  <span class="comment">// _read_images should realize</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;data()-&gt;flags &amp; RW_LOADED) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ensure superclass-first ordering</span></span><br><span class="line">    schedule_class_load(cls-&gt;superclass);</span><br><span class="line"></span><br><span class="line">    add_class_to_loadable_list(cls);</span><br><span class="line">    cls-&gt;setInfo(RW_LOADED); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>é€šè¿‡ <code>RW_LOADED</code> æ ‡å¿—ä½åˆ¤æ–­ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡åˆ™ç›´æ¥è¿”å›ï¼Œä¿è¯<strong>æ¯ä¸ªç±»åªä¼šåŠ è½½ä¸€æ¬¡</strong></li>
<li>é€’å½’è°ƒç”¨ <code>schedule_class_load</code> å¯¹çˆ¶ç±»è¿›è¡Œå¤„ç†ï¼Œä¿è¯<strong>çˆ¶ç±»åœ¨å­ç±»ä¹‹å‰</strong>ï¼ˆè¿™é‡Œåªæ˜¯â€prepareâ€ï¼Œä¸æ˜¯è°ƒç”¨ï¼Œä¸è¿‡çœŸæ­£è°ƒç”¨çš„æ—¶å€™çˆ¶ç±»ä¹Ÿä¸€å®šæ˜¯åœ¨å­ç±»ä¹‹å‰çš„ï¼Œåé¢ä¼šè¯¦è¿°ï¼‰</li>
<li>å°†ç±»å’Œç±»çš„ load æ–¹æ³•ä¿å­˜è‡³ä¸€ä¸ªå…¨å±€åˆ—è¡¨ï¼ˆ<code>loadable_classes</code>ï¼‰ä¸­</li>
<li>å°†ç±»çš„ <code>RW_LOADED</code> æ ‡å¿—ä½ç½®ä¸º 1</li>
</ol>
<p>#####add_class_to_loadable_list</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-loadmethod.mm</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_class_to_loadable_list</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IMP method;</span><br><span class="line"></span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    method = cls-&gt;getLoadMethod();</span><br><span class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span>;  <span class="comment">// Don't bother if cls has no +load method</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (PrintLoading) &#123;</span><br><span class="line">        _objc_inform(<span class="string">"LOAD: class '%s' scheduled for +load"</span>, </span><br><span class="line">                     cls-&gt;nameForLogging());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (loadable_classes_used == loadable_classes_allocated) &#123;</span><br><span class="line">        loadable_classes_allocated = loadable_classes_allocated*<span class="number">2</span> + <span class="number">16</span>;</span><br><span class="line">        loadable_classes = (struct loadable_class *)</span><br><span class="line">            <span class="built_in">realloc</span>(loadable_classes,</span><br><span class="line">                              loadable_classes_allocated *</span><br><span class="line">                              <span class="keyword">sizeof</span>(struct loadable_class));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    loadable_classes[loadable_classes_used].cls = cls;</span><br><span class="line">    loadable_classes[loadable_classes_used].method = method;</span><br><span class="line">    loadable_classes_used++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™é‡Œé€šè¿‡ <code>loadable_classes_used</code> è®°å½•å…¶ä¸ªæ•°ï¼Œ<code>loadable_classes</code> åˆ—è¡¨çš„å¤§å°æ˜¯åŠ¨æ€åˆ›å»ºçš„ï¼Œå½“åˆ—è¡¨é•¿åº¦ä¸å¤Ÿç”¨æ—¶ä¼šé‡æ–°ç”³è¯·å†…å­˜ã€‚ï¼ˆæˆ‘æƒ³è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¦‚æœç¨‹åºä¸­ <code>+ load</code> æ–¹æ³•å¤ªå¤šæ—¶ï¼Œä¼šå½±å“å¯åŠ¨æ€§èƒ½çš„åŸå› ä¹‹ä¸€å§ã€‚å½“ç„¶å½±å“å› ç´ å¾ˆå¤šï¼Œåé¢æˆ‘ä»¬è¿˜ä¼šè¯¦è¿°ï¼‰</p>
<blockquote>
<p>ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼ŒğŸ å·¥ç¨‹å¸ˆè¿˜éå¸¸ <del>é€—æ¯”</del> æœ‰è¶£çš„åŠ äº†ä¸€å¥æ³¨é‡Šï¼šâ€œå¦‚æœç±»æ²¡æœ‰loadæ–¹æ³•ï¼Œè¯·ä¸è¦æ‰“æ‰°â€ã€‚ğŸ˜‚</p>
</blockquote>
<h5 id="add-category-to-loadable-list"><a href="#add-category-to-loadable-list" class="headerlink" title="add_category_to_loadable_list"></a>add_category_to_loadable_list</h5><p>åˆ†ç±»çš„å¤„ç†å’Œç±»çš„å¤„ç†å·®ä¸å¤šï¼šå°†åˆ†ç±»å’Œåˆ†ç±»çš„ load æ–¹æ³•ä¿å­˜è‡³å¦ä¸€ä¸ªå…¨å±€åˆ—è¡¨ <code>loadable_categories</code> ä¸­ï¼Œé€šè¿‡ <code>loadable_categories_used</code> è®°å½•å…¶ä¸ªæ•°ã€‚æˆ‘ä»¬å°±ä¸å†èµ˜è¿°äº†ã€‚</p>
<h5 id="remapClass"><a href="#remapClass" class="headerlink" title="remapClass"></a>remapClass</h5><p>ä¸Šé¢æˆ‘ä»¬è¯´ä¸ºäº†é˜²æ­¢æ··ä¹±è€Œæš‚æ—¶å¿½ç•¥äº†ä¸€ä¸ªæ–¹æ³• <code>remapClass</code>ã€‚å…¶å®é€šè¿‡ <code>_getObjc2NonlazyClassList</code> è·å–çš„æ˜¯ <code>classref_t</code>ï¼Œé€šè¿‡æ³¨é‡Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå…¶å®æ˜¯ä¸€ä¸ªâ€œæœªæ˜ å°„â€çš„ Classï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// classref_t is unremapped class_t*</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">classref</span> * <span class="title">classref_t</span>;</span></span><br></pre></td></tr></table></figure>
<p>è€Œ <code>remapClass</code> çš„ä½œç”¨å°±æ˜¯å°† <code>classref_t</code> è¿›è¡Œé‡æ˜ å°„ï¼Œæ‹¿åˆ°å…¶æ‰€å¯¹åº”çš„ Classï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.mm</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Class <span class="title">remapClass</span><span class="params">(<span class="keyword">classref_t</span> cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> remapClass((Class)cls);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> Class <span class="title">remapClass</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    Class c2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> nil;</span><br><span class="line"></span><br><span class="line">    NXMapTable *<span class="built_in">map</span> = remappedClasses(NO);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">map</span>  ||  NXMapMember(<span class="built_in">map</span>, cls, (<span class="keyword">void</span>**)&amp;c2) == NX_MAPNOTAKEY) &#123;</span><br><span class="line">        <span class="keyword">return</span> cls;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> c2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»é•œåƒä¸­è·å–åˆ°çš„æœªæ˜ å°„çš„ <code>classref_t</code> ä¸å…¶æ‰€å¯¹åº”çš„çœŸæ­£çš„ Class æ˜¯ä½œä¸ºä¸€å¯¹ key-value å­˜å‚¨åœ¨ä¸€ä¸ªæ˜ å°„è¡¨é‡Œçš„ï¼Œå…¶ä¸­ <code>classref_t</code> æ˜¯ keyï¼Œå¯¹åº”çš„ Class æ˜¯ valueã€‚</p>
<p>ä¸è¿‡çœ‹åˆ°è¿™æˆ‘ä»¬è¿˜æ˜¯ä¸çŸ¥é“ï¼Œè¿™ä¸ªæ˜ å°„è¡¨æ˜¯å“ªæ¥çš„ï¼Ÿåé¢æˆ‘ä»¬ä¼šè¯¦è¿°ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ç¬¬ä¸‰æ­¥ï¼š<code>call_load_methods</code></p>
<h4 id="call-load-methods"><a href="#call-load-methods" class="headerlink" title="call_load_methods"></a>call_load_methods</h4><p>do while ä¸­ä¼šå…ˆè°ƒç”¨ <code>call_class_loads</code>ï¼Œå†è°ƒç”¨ call_category_loadsï¼Œè¿™å°±ä¿è¯äº†<strong>ç±»çš„ <code>+ load</code> ä¼šåœ¨åˆ†ç±»ä¹‹å‰è°ƒç”¨</strong>ã€‚ï¼ˆè¿˜è®°å¾— <code>loadable_classes_used</code> å—ï¼Œæˆ‘ä»¬ä¸Šæ–‡æè¿‡å“¦ã€‚ï¼‰</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_load_methods</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> loading = NO;</span><br><span class="line">    <span class="keyword">bool</span> more_categories;</span><br><span class="line"></span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Re-entrant calls do nothing; the outermost call will finish the job.</span></span><br><span class="line">    <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</span><br><span class="line">    loading = YES;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *pool = objc_autoreleasePoolPush();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Repeatedly call class +loads until there aren't any more</span></span><br><span class="line">        <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            call_class_loads();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. Call category +loads ONCE</span></span><br><span class="line">        more_categories = call_category_loads();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. Run more +loads if there are classes OR more untried categories</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</span><br><span class="line"></span><br><span class="line">    objc_autoreleasePoolPop(pool);</span><br><span class="line"></span><br><span class="line">    loading = NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç½‘ä¸Šæœ‰äº›åšå®¢è¯´ï¼Œæˆ‘ä»¬é‡è½½ <code>+ load</code> æ–¹æ³•æ—¶éœ€è¦æ‰‹åŠ¨æ·»åŠ  @autoreleasepoolï¼Œç”šè‡³åŒ…æ‹¬<a href="https://www.mikeash.com/pyblog/friday-qa-2009-05-22-objective-c-class-loading-and-initialization.html" target="_blank" rel="noopener">Mike Ash çš„åšå®¢</a>ä¹Ÿæ˜¯è¿™ä¹ˆè¯´çš„ã€‚</p>
<p>ä½†ä»è¿™æ®µæºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>runtime</code> è°ƒç”¨<code>+ load</code> æ–¹æ³•çš„å‰åå·²ç»åŠ äº† <code>objc_autoreleasePoolPush()</code> å’Œ <code>objc_autoreleasePoolPop()</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å†æ‰‹åŠ¨æ·»åŠ äº†ã€‚å¤§æŠµæ˜¯å› ä¸ºä»–ä»¬æ‰€å†™çš„åšå®¢å¤ªè€äº†ï¼Œä¹‹åğŸåšäº†æ›´æ–°å§ã€‚</p>
<h5 id="call-class-loads"><a href="#call-class-loads" class="headerlink" title="call_class_loads"></a>call_class_loads</h5><p><code>call_class_loads</code> å°±æ˜¯å°†æˆ‘ä»¬ä¸Šæ–‡æ‰€è¯´çš„ <code>loadable_classes</code> åˆ—è¡¨ä¸­çš„ç±»ä¸€ä¸ªä¸€ä¸ªæ‹¿å‡ºæ¥ï¼Œç„¶åè°ƒç”¨å…¶ <code>+ load</code> æ–¹æ³•ã€‚å› ä¸ºä¹‹å‰å†™å…¥ <code>loadable_classes</code> åˆ—è¡¨æ—¶ï¼Œæ˜¯å…ˆå†™å…¥çš„çˆ¶ç±»ï¼Œåå†™å…¥çš„å­ç±»ï¼Œæ‰€ä»¥è¿™é‡Œ<strong>çˆ¶ç±»çš„ load ä¼šå…ˆäºå­ç±»è°ƒç”¨</strong>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">call_class_loads</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Detach current loadable list.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">loadable_class</span> *<span class="title">classes</span> = <span class="title">loadable_classes</span>;</span></span><br><span class="line">    <span class="keyword">int</span> used = loadable_classes_used;</span><br><span class="line">    loadable_classes = nil;</span><br><span class="line">    loadable_classes_allocated = <span class="number">0</span>;</span><br><span class="line">    loadable_classes_used = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Call all +loads for the detached list.</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</span><br><span class="line">        Class cls = classes[i].cls;</span><br><span class="line">        <span class="keyword">load_method_t</span> load_method = (<span class="keyword">load_method_t</span>)classes[i].method;</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PrintLoading) &#123;</span><br><span class="line">            _objc_inform(<span class="string">"LOAD: +[%s load]\n"</span>, cls-&gt;nameForLogging());</span><br><span class="line">        &#125;</span><br><span class="line">        (*load_method)(cls, SEL_load);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Destroy the detached list.</span></span><br><span class="line">    <span class="keyword">if</span> (classes) <span class="built_in">free</span>(classes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¸å¿ƒåœ¨äºè¿™ä¸€å¥ï¼Œé€šè¿‡å‡½æ•°æŒ‡é’ˆçš„æ–¹å¼æ‰§è¡Œ <code>classes[i].method</code>â€”â€”ä¹Ÿå°±æ˜¯ <code>+ load</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(*load_method)(cls, SEL_load);</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·çš„è°ƒç”¨æ–¹å¼å°±ä½¿å¾— <code>+ load</code> æœ‰äº†ä¸€ä¸ªéå¸¸æœ‰è¶£çš„ç‰¹æ€§ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œé€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ç»™ä¸€ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯ï¼Œå…¶å®æ˜¯è°ƒç”¨äº† <code>objc_msgSend</code> æ–¹æ³•ï¼Œå¦‚æœå¯¹è±¡ä¸èƒ½å“åº”æ¶ˆæ¯ï¼Œä¼šé€’å½’åœ°æŸ¥æ‰¾å…¶çˆ¶ç±»/å…ƒç±»å¹¶è°ƒç”¨ã€‚</p>
<p>è€Œæ­¤å¤„ <code>+ load</code> æ–¹æ³•ç›´æ¥ä½¿ç”¨äº†å‡½æ•°åœ°å€è¿›è¡Œè°ƒç”¨ï¼Œå¹¶ä¸æ˜¯é€šè¿‡ <code>objc_msgSend</code>ï¼Œæ‰€ä»¥<strong>å¦‚æœå­ç±»æ²¡æœ‰å®ç° <code>+ load</code> æ–¹æ³•ï¼Œé‚£ä¹ˆ runtime ä¸ä¼šè°ƒç”¨çˆ¶ç±»çš„ <code>+ load</code>ã€‚å¦‚æœç±»å’Œåˆ†ç±»éƒ½å®ç°äº† <code>+ load</code> æ–¹æ³•ï¼Œä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè¢«è°ƒç”¨</strong>ã€‚</p>
<p>åˆ°è¿™é‡Œ <code>load_images</code> çš„æ•´ä¸ªæµç¨‹å°±è®²å®Œäº†ï¼Œä¸è¿‡å¦‚æœä½ è·Ÿæˆ‘ä¸€æ ·å¥½å¥‡çš„è¯ï¼ŒæŸ¥çœ‹ <code>SEL_load</code> æ—¶ä¼šå‘ç°â€”â€”å®ƒç«Ÿç„¶æ˜¯ä¸ª <code>NULL</code>ï¼ï¼ï¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// objc-runtime.mm</span><br><span class="line">// Selectors</span><br><span class="line">SEL SEL_load = NULL;</span><br><span class="line">SEL SEL_initialize = NULL;</span><br><span class="line">SEL SEL_resolveInstanceMethod = NULL;</span><br><span class="line">SEL SEL_resolveClassMethod = NULL;</span><br><span class="line">SEL SEL_cxx_construct = NULL;</span><br><span class="line">SEL SEL_cxx_destruct = NULL;</span><br><span class="line">SEL SEL_retain = NULL;</span><br><span class="line">SEL SEL_release = NULL;</span><br><span class="line">SEL SEL_autorelease = NULL;</span><br><span class="line">SEL SEL_retainCount = NULL;</span><br><span class="line">SEL SEL_alloc = NULL;</span><br><span class="line">SEL SEL_allocWithZone = NULL;</span><br><span class="line">SEL SEL_dealloc = NULL;</span><br><span class="line">SEL SEL_copy = NULL;</span><br><span class="line">SEL SEL_new = NULL;</span><br><span class="line">SEL SEL_forwardInvocation = NULL;</span><br><span class="line">SEL SEL_tryRetain = NULL;</span><br><span class="line">SEL SEL_isDeallocating = NULL;</span><br><span class="line">SEL SEL_retainWeakReference = NULL;</span><br><span class="line">SEL SEL_allowsWeakReference = NULL;</span><br></pre></td></tr></table></figure>
<p>è‡³äºä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œæˆ‘ä»¬åé¢ä¼šè¯¦è¿°ã€‚</p>
<h4 id="Producer-Consumer"><a href="#Producer-Consumer" class="headerlink" title="Producer-Consumer"></a>Producer-Consumer</h4><p>ç»†å¿ƒçš„è¯»è€…å¯èƒ½å·²ç»å‘ç°äº†ï¼Œ<code>load_images</code> é‡Œå…¶å®è•´å«ç€ä¸€ä¸ªç»å…¸çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼š</p>
<ul>
<li><code>prepare_load_methods</code> è´Ÿè´£â€œç”Ÿäº§â€ï¼šä»é•œåƒä¸­è·å–å®ç°äº† <code>+ load</code> æ–¹æ³•çš„ç±»/åˆ†ç±»ï¼Œå°†ç±»/åˆ†ç±»åŠå…¶ load æ–¹æ³•å†™å…¥ <code>loadable_classes</code>/<code>loadable_categories</code> åˆ—è¡¨ä¸­ï¼›</li>
<li><code>call_load_methods</code> è´Ÿè´£â€œæ¶ˆè´¹â€ï¼šå¾ªç¯åœ°ä» <code>loadable_classes</code>/<code>loadable_categories</code> åˆ—è¡¨ä¸­è¯»å–ç±»/åˆ†ç±»ï¼Œæ‰§è¡Œå…¶ <code>+ load</code> æ–¹æ³•</li>
</ul>
<h5 id="loadMethodLock"><a href="#loadMethodLock" class="headerlink" title="loadMethodLock"></a>loadMethodLock</h5><p>å½“ç„¶ï¼ŒğŸ å·²ç»åŠ å¥½äº†é”ã€‚å› ä¸ºç±»å’Œåˆ†ç±»çš„æµç¨‹å¤§åŒå°å¼‚ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¥ç±»ä¸ºğŸŒ°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `prepare_load_methods` è´Ÿè´£â€œç”Ÿäº§â€</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_class_to_loadable_list</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    loadable_classes[loadable_classes_used].cls = cls;</span><br><span class="line">    loadable_classes[loadable_classes_used].method = method;</span><br><span class="line">    loadable_classes_used++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// `call_load_methods` è´Ÿè´£â€œæ¶ˆè´¹â€</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_load_methods</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    call_class_loads</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">call_class_loads</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">loadable_class</span> *<span class="title">classes</span> = <span class="title">loadable_classes</span>;</span></span><br><span class="line">    <span class="keyword">int</span> used = loadable_classes_used;</span><br><span class="line">    loadable_classes = nil;</span><br><span class="line">    loadable_classes_allocated = <span class="number">0</span>;</span><br><span class="line">    loadable_classes_used = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    (*load_method)(cls, SEL_load);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (classes) <span class="built_in">free</span>(classes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="objc-init"><a href="#objc-init" class="headerlink" title="_objc_init"></a>_objc_init</h2><p>è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰é—ç•™çš„é—®é¢˜å—ï¼ŸremapClass ä¸­çš„é‚£ä¸ªæ˜ å°„è¡¨æ˜¯å“ªæ¥çš„ï¼Ÿ<code>SEL_load</code> ç­‰é€‰æ‹©å­ä¸ºä»€ä¹ˆæ˜¯ NULLï¼Ÿ</p>
<p>ä¹‹æ‰€ä»¥ä¼šé‡åˆ°è¿™äº›é—®é¢˜ï¼Œå…¶å®æ˜¯å› ä¸ºæˆ‘ä»¬å‰é¢æœ‰äº›â€œæ€¥äºæ±‚æˆâ€ï¼Œä» <code>load</code> æ–¹æ³•å¤„çš„æ–­ç‚¹å®šä½åˆ° <code>load_images</code> åå°±ç›´æ¥ä¸€å¤´æ‰äº†è¿›å»ï¼Œè€Œæ²¡æœ‰æƒ³æƒ³â€”â€”<code>load_images</code> æ˜¯è°è°ƒç”¨çš„ï¼Ÿåœ¨ <code>load_images</code> ä¹‹å‰å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>
<p>æˆ‘ä»¬åœ¨ <code>load_images</code> å¤„æ·»åŠ ä¸€ä¸ªæ–­ç‚¹ï¼Œé€šè¿‡è°ƒç”¨æ ˆå¯ä»¥çœ‹åˆ°å¦ä¸€ä¸ªæ–¹æ³•ï¼š<code>_objc_init</code></p>
<p><img src="/2019/05/16/Runtime æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Breakpoint_LoadImages.png" alt="Runtime_Breakpoint_LoadImages"></p>
<p>å…¶æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-os.mm</span></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _objc_init</span></span><br><span class="line"><span class="comment">* Bootstrap initialization. Registers our image notifier with dyld.</span></span><br><span class="line"><span class="comment">* Called by libSystem BEFORE library initialization time</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">void</span> _objc_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> initialized = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fixme defer initialization until an objc-using image is found?</span></span><br><span class="line">    environ_init();</span><br><span class="line">    tls_init();</span><br><span class="line">    static_init();</span><br><span class="line">    lock_init();</span><br><span class="line">    exception_init();</span><br><span class="line"></span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåšäº†å¾ˆå¤šåˆå§‹åŒ–çš„å·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ªé™æ€çš„å¸ƒå°”å‹å˜é‡ä¿è¯è¯¥æ–¹æ³•åªä¼šèµ°ä¸€æ¬¡ã€‚æˆ‘ä»¬çš„å…³æ³¨ç‚¹åœ¨äºæœ€åä¸€è¡Œï¼Œè¿™é‡Œå‡ºç°äº†æˆ‘ä»¬å‰é¢èŠ±äº†å¤§é‡ç¯‡å¹…æ‰€è®²çš„ <code>load_images</code>ï¼Œé‚£ä¹ˆè¿™ä¸€æ•´è¡Œä»£ç æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p>
<h3 id="dyld-objc-notify-register"><a href="#dyld-objc-notify-register" class="headerlink" title="_dyld_objc_notify_register"></a>_dyld_objc_notify_register</h3><p>æˆ‘ä»¬è·³è½¬åˆ° <code>_dyld_objc_notify_register</code> çš„å®šä¹‰ï¼Œè¿™é‡Œå·²ç»è¸å…¥ dyld çš„é¢†åœ°äº†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dyld_priv.h</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*_dyld_objc_notify_mapped)</span><span class="params">(<span class="keyword">unsigned</span> count, <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> paths[], <span class="keyword">const</span> struct mach_header* <span class="keyword">const</span> mh[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*_dyld_objc_notify_init)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">const</span> struct mach_header* mh)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*_dyld_objc_notify_unmapped)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">const</span> struct mach_header* mh)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Note: only for use by objc runtime</span></span><br><span class="line"><span class="comment">// Register handlers to be called when objc images are mapped, unmapped, and initialized.</span></span><br><span class="line"><span class="comment">// Dyld will call back the "mapped" function with an array of images that contain an objc-image-info section.</span></span><br><span class="line"><span class="comment">// Those images that are dylibs will have the ref-counts automatically bumped, so objc will no longer need to</span></span><br><span class="line"><span class="comment">// call dlopen() on them to keep them from being unloaded.  During the call to _dyld_objc_notify_register(),</span></span><br><span class="line"><span class="comment">// dyld will call the "mapped" function with already loaded objc images.  During any later dlopen() call,</span></span><br><span class="line"><span class="comment">// dyld will also call the "mapped" function.  Dyld will call the "init" function when dyld would be called</span></span><br><span class="line"><span class="comment">// initializers in that image.  This is when objc calls any +load methods in that image.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">void</span> _dyld_objc_notify_register(_dyld_objc_notify_mapped    mapped,</span><br><span class="line">                                _dyld_objc_notify_init      init,</span><br><span class="line">                                _dyld_objc_notify_unmapped  unmapped);</span><br></pre></td></tr></table></figure>
<p>è¯·å…è®¸æˆ‘è¹©è„šçš„ç¿»è¯‘ä¸€ä¸‹å…¶ä¸­çš„éƒ¨åˆ†å†…å®¹ï¼š</p>
<blockquote>
<p>â€œæ³¨å†Œå¤„ç†ç¨‹åºï¼Œä»¥ä¾¿ oc çš„é•œåƒåœ¨è¢« mappedã€unmappped å’Œ initialized æ—¶è°ƒç”¨â€¦â€¦å½“ dyld åˆå§‹åŒ–ä¸€ä¸ªé•œåƒæ—¶ï¼Œä¼šè°ƒç”¨ init å‡½æ•°ï¼Œé•œåƒçš„ + load æ–¹æ³•å°±åœ¨è¿™ä¸ªå‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚â€</p>
</blockquote>
<p>ï¼ˆè¿™é‡Œçš„ â€œinit functionâ€ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡æ‰€è¯´çš„ <code>load_images</code>ï¼‰</p>
<p>æ‰€ä»¥ runtime å…¶å®æ˜¯æ³¨å†Œäº†ä¸‰ä¸ªç›‘å¬ï¼š<code>_dyld_objc_notify_mapped</code> ã€ <code>_dyld_objc_notify_init</code> ã€ <code>_dyld_objc_notify_unmapped</code>ï¼Œå¯¹åº”ç€ä¸‰ä¸ªä¸åŒçš„å›è°ƒã€‚å½“ä¸€ä¸ªé•œåƒè¢« mappedã€init å’Œ unmapped æ—¶ï¼Œdyld å°±ä¼šé€šçŸ¥ runtime è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚</p>
<p> é‚£ä¹ˆæ˜¾ç„¶ï¼Œæƒ³è¦è§£ç­”æˆ‘ä»¬ä¹‹å‰é—ç•™çš„å›°æƒ‘ï¼Œå°±éœ€è¦å»çœ‹çœ‹åœ¨ â€œinitâ€ ä¹‹å‰çš„ â€œmappedâ€ ä¸­éƒ½åšäº†äº›ä»€ä¹ˆã€‚</p>
<h3 id="map-images"><a href="#map-images" class="headerlink" title="map_images"></a>map_images</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//objc-runtime-new.mm</span></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* map_images</span></span><br><span class="line"><span class="comment">* Process the given images which are being mapped in by dyld.</span></span><br><span class="line"><span class="comment">* Calls ABI-agnostic code after taking ABI-specific locks.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: write-locks runtimeLock</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">map_images(<span class="keyword">unsigned</span> count, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> paths[],</span><br><span class="line">           <span class="keyword">const</span> struct mach_header * <span class="keyword">const</span> mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">mutex_locker_t</span> lock(runtimeLock);</span><br><span class="line">    <span class="keyword">return</span> map_images_nolock(count, paths, mhdrs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="map-images-nolock"><a href="#map-images-nolock" class="headerlink" title="map_images_nolock"></a>map_images_nolock</h4><p><code>map_images_nolock</code> çš„å®ç°æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬å¿½ç•¥æ‰ä¸€äº›ç›¸å¯¹ä¸é‚£ä¹ˆé‡è¦çš„å†…å®¹ï¼Œç„¶åæŒ‘é€‰å…¶ä¸­ä¸€éƒ¨åˆ†è®²è®²ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-os.mm</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">map_images_nolock(<span class="keyword">unsigned</span> mhCount, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> mhPaths[],</span><br><span class="line">                  <span class="keyword">const</span> struct mach_header * <span class="keyword">const</span> mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> firstTime = YES;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (firstTime) &#123;</span><br><span class="line">        sel_init(selrefCount);</span><br><span class="line">        arr_init();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (hCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        _read_images(hList, hCount, totalClasses, unoptimizedTotalClasses);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    firstTime = NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œè¿™é‡Œä¼šåšä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œä¸‹é¢æˆ‘ä»¬å°±åˆ†åˆ«æ¥çœ‹ä¸€ä¸‹ <code>sel_init</code> ã€ <code>arr_init</code> ã€ <code>_read_images</code> è¿™ä¸‰æ­¥éƒ½åšäº†äº›ä»€ä¹ˆã€‚</p>
<h5 id="sel-init"><a href="#sel-init" class="headerlink" title="sel_init"></a>sel_init</h5><p>é¡¾åæ€ä¹‰ï¼Œè¿™é‡Œå°±æ˜¯åˆå§‹åŒ– SEL çš„åœ°æ–¹ï¼Œæˆ‘ä»¬å‰é¢çš„é—®é¢˜ <code>SEL SEL_load = NULL;</code> ä¹Ÿå°†åœ¨è¿™é‡Œå¾—åˆ°è§£ç­”ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-sel.mm</span></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* sel_init</span></span><br><span class="line"><span class="comment">* Initialize selector tables and register selectors used internally.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sel_init</span><span class="params">(<span class="keyword">size_t</span> selrefCount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// ...ç•¥</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register selectors used by libobjc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> s(x) SEL_##x = sel_registerNameNoLock(#x, NO)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> t(x,y) SEL_##y = sel_registerNameNoLock(#x, NO)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutex_locker_t</span> lock(selLock);</span><br><span class="line"></span><br><span class="line">    s(load);</span><br><span class="line">    s(initialize);</span><br><span class="line">    t(resolveInstanceMethod:, resolveInstanceMethod);</span><br><span class="line">    t(resolveClassMethod:, resolveClassMethod);</span><br><span class="line">    t(.cxx_construct, cxx_construct);</span><br><span class="line">    t(.cxx_destruct, cxx_destruct);</span><br><span class="line">    s(retain);</span><br><span class="line">    s(release);</span><br><span class="line">    s(autorelease);</span><br><span class="line">    s(retainCount);</span><br><span class="line">    s(alloc);</span><br><span class="line">    t(allocWithZone:, allocWithZone);</span><br><span class="line">    s(dealloc);</span><br><span class="line">    s(copy);</span><br><span class="line">    s(<span class="keyword">new</span>);</span><br><span class="line">    t(forwardInvocation:, forwardInvocation);</span><br><span class="line">    t(_tryRetain, tryRetain);</span><br><span class="line">    t(_isDeallocating, isDeallocating);</span><br><span class="line">    s(retainWeakReference);</span><br><span class="line">    s(allowsWeakReference);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> s</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> t</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»ä¼¼åœ°ï¼Œè¿™é‡Œä¹Ÿ <del>å·æ‡’</del> å·§å¦™çš„ä½¿ç”¨äº†å®å®šä¹‰æ¥èµ·åˆ°æ¨¡æ¿çš„ä½œç”¨ã€‚æˆ‘ä»¬ä»¥ <code>load</code> ä¸ºğŸŒ°ï¼Œ<code>s(load);</code> ç›¸å½“äºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SEL_load = sel_registerNameNoLock(&quot;load&quot;, NO);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>##</code> æ˜¯æ‹¼æ¥ï¼Œ<code>#</code> æ˜¯è½¬åŒ–ä¸ºå­—ç¬¦ä¸²</p>
</blockquote>
<p>æœ€ç»ˆè°ƒç”¨çš„æ˜¯ <code>__sel_registerName</code>ï¼Œè¿™é‡Œä¼šå»ä¸€ä¸ªå…¨å±€çš„æ˜ å°„è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœè¡¨ä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªï¼Œå¦‚æœåœ¨è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™å°† SEL name å’Œ SEL ä½œä¸ºä¸€å¯¹ key-value æ·»åŠ åˆ°æ˜ å°„è¡¨ä¸­ã€‚è‡³æ­¤æˆ‘ä»¬å…³äº SEL çš„é—®é¢˜ä¾¿å¾—åˆ°äº†ç­”æ¡ˆã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-sel.mm</span></span><br><span class="line"><span class="keyword">static</span> SEL __sel_registerName(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">bool</span> shouldLock, <span class="keyword">bool</span> copy) </span><br><span class="line">&#123;</span><br><span class="line">    SEL result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...ç•¥</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (namedSelectors) &#123;</span><br><span class="line">        result = (SEL)NXMapGet(namedSelectors, name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result) <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!namedSelectors) &#123;</span><br><span class="line">        namedSelectors = NXCreateMapTable(NXStrValueMapPrototype, </span><br><span class="line">                                          (<span class="keyword">unsigned</span>)SelrefCount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">        result = sel_alloc(name, copy);</span><br><span class="line">        NXMapInsert(namedSelectors, sel_getName(result), result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="arr-init"><a href="#arr-init" class="headerlink" title="arr_init"></a>arr_init</h5><p>å›åˆ° <code>map_images_nolock</code> ä¸­ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹å¦ä¸€ä¸ªåˆå§‹åŒ–ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arr_init</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AutoreleasePoolPage::init();</span><br><span class="line">    SideTableInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸæ¥ <code>AutoreleasePool</code> å’Œ <code>SideTable</code> éƒ½æ˜¯åœ¨è¿™é‡Œåˆå§‹åŒ–çš„ã€‚æœ‰çš„åŒå­¦å¯èƒ½å¯¹ <code>SideTable</code> æ¯”è¾ƒé™Œç”Ÿï¼Œå¤§åé¼é¼çš„å¼•ç”¨è®¡æ•°è¡¨ä»¥åŠ <code>weak</code> çš„å®ç°åŸç†ç­‰ï¼Œå…¨éƒ½å’Œå®ƒæœ‰å…³ã€‚å…³äº <code>AutoreleasePool</code> å’Œ <code>SideTable</code>ï¼Œæˆ‘ä»¬ä¼šåœ¨å…¶å®ƒæ–‡ç« ä¸­å•ç‹¬ä»‹ç»ã€‚</p>
<h5 id="read-images"><a href="#read-images" class="headerlink" title="_read_images"></a>_read_images</h5><p>ç°åœ¨ <code>map_images_nolock</code> ä¸­åªå‰©ä¸‹ä¸€ä¸ªé‡å¤´æˆï¼š<code>_read_images</code> äº†ã€‚è¿™ä¸ªæ–¹æ³•çš„å®ç°é•¿å¾—ä»¤äººå‘æŒ‡ï¼ˆ400è¡Œï¼‰ï¼Œ<del>ç¬”è€…å·²ç»æ— åŠ›åæ§½</del>ï¼Œä¸»è¦æ˜¯æ£€æŸ¥æ‰€æœ‰çš„ header_intoï¼Œå¤„ç†å…¶ä¸­çš„ ç±»ã€åˆ†ç±»ã€åè®®ã€æ¶ˆæ¯ç­‰ä¿¡æ¯ï¼Œæ’å…¥ç›¸åº”çš„æ˜ å°„è¡¨ä¸­ã€‚æˆ‘ä»¬æ‘˜å–å…¶ä¸­æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.mm</span></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _read_images</span></span><br><span class="line"><span class="comment">* Perform initial processing of the headers in the linked </span></span><br><span class="line"><span class="comment">* list beginning with headerList. </span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Called by: map_images_nolock</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock acquired by map_images</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">void</span> _read_images(header_info **hList, <span class="keyword">uint32_t</span> hCount, <span class="keyword">int</span> totalClasses, <span class="keyword">int</span> unoptimizedTotalClasses)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    <span class="function">TimeLogger <span class="title">ts</span><span class="params">(PrintImageTimes)</span></span>;</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    NXCreateHashTable</span><br><span class="line">    ts.<span class="built_in">log</span>(<span class="string">"IMAGE TIMES: first time tasks"</span>);</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    _getObjc2ClassList</span><br><span class="line">    readClass</span><br><span class="line">	ts.<span class="built_in">log</span>(<span class="string">"IMAGE TIMES: discover classes"</span>);</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    _getObjc2ClassRefs</span><br><span class="line">    remapClassRef</span><br><span class="line">    ts.<span class="built_in">log</span>(<span class="string">"IMAGE TIMES: remap classes"</span>);</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    _getObjc2SelectorRefs</span><br><span class="line">    sel_registerNameNoLock</span><br><span class="line">    ts.<span class="built_in">log</span>(<span class="string">"IMAGE TIMES: fix up selector references"</span>);</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    _getObjc2MessageRefs</span><br><span class="line">    fixupMessageRef</span><br><span class="line">	ts.<span class="built_in">log</span>(<span class="string">"IMAGE TIMES: fix up objc_msgSend_fixup"</span>);</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    _getObjc2ProtocolList</span><br><span class="line">    readProtocol</span><br><span class="line">    ts.<span class="built_in">log</span>(<span class="string">"IMAGE TIMES: discover protocols"</span>);</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    _getObjc2ProtocolRefs</span><br><span class="line">    remapProtocolRef</span><br><span class="line">    ts.<span class="built_in">log</span>(<span class="string">"IMAGE TIMES: fix up @protocol references"</span>);</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    _getObjc2NonlazyClassList</span><br><span class="line">    realizeClass</span><br><span class="line">	ts.<span class="built_in">log</span>(<span class="string">"IMAGE TIMES: realize non-lazy classes"</span>);</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">    _getObjc2CategoryList</span><br><span class="line">    addUnattachedCategoryForClass</span><br><span class="line">    remethodizeClass</span><br><span class="line">	ts.<span class="built_in">log</span>(<span class="string">"IMAGE TIMES: discover categories"</span>);</span><br><span class="line">    <span class="comment">// ... ç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¢æ¯ä¸€å¤„éƒ½æ˜¯ä¸€æ¬¡å¯¹æ‰€æœ‰ header_info çš„éå†ï¼ˆä½†å…¶å®æˆ‘ä¸å¤ªæ˜ç™½åœ¨ä¸€æ¬¡éå†ä¸­åšè¿™äº›äº‹ä¸è¡Œä¹ˆï¼Ÿï¼‰</p>
<p>è¿™é‡ŒğŸå·²ç»å†™å¥½äº†å„ä¸ªæ­¥éª¤è€—æ—¶çš„ç›‘æµ‹ï¼Œæˆ‘ä»¬çœ‹ä¸Šé¢çš„ç¬¬ä¸€è¡Œä»£ç ï¼š<code>TimeLogger ts(PrintImageTimes);</code> ï¼Œæˆ‘ä»¬è·³è½¬åˆ° <code>PrintImageTimes</code> çš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">// objc-env.h</span><br><span class="line">// OPTION(var, env, help)</span><br><span class="line"></span><br><span class="line">OPTION( PrintImages,              OBJC_PRINT_IMAGES,               &quot;log image and library names as they are loaded&quot;)</span><br><span class="line">OPTION( PrintImageTimes,          OBJC_PRINT_IMAGE_TIMES,          &quot;measure duration of image loading steps&quot;)</span><br><span class="line">OPTION( PrintLoading,             OBJC_PRINT_LOAD_METHODS,         &quot;log calls to class and category +load methods&quot;)</span><br><span class="line">OPTION( PrintInitializing,        OBJC_PRINT_INITIALIZE_METHODS,   &quot;log calls to class +initialize methods&quot;)</span><br><span class="line">OPTION( PrintResolving,           OBJC_PRINT_RESOLVED_METHODS,     &quot;log methods created by +resolveClassMethod: and +resolveInstanceMethod:&quot;)</span><br><span class="line">OPTION( PrintConnecting,          OBJC_PRINT_CLASS_SETUP,          &quot;log progress of class and category setup&quot;)</span><br><span class="line">OPTION( PrintProtocols,           OBJC_PRINT_PROTOCOL_SETUP,       &quot;log progress of protocol setup&quot;)</span><br><span class="line">OPTION( PrintIvars,               OBJC_PRINT_IVAR_SETUP,           &quot;log processing of non-fragile ivars&quot;)</span><br><span class="line">OPTION( PrintVtables,             OBJC_PRINT_VTABLE_SETUP,         &quot;log processing of class vtables&quot;)</span><br><span class="line">OPTION( PrintVtableImages,        OBJC_PRINT_VTABLE_IMAGES,        &quot;print vtable images showing overridden methods&quot;)</span><br><span class="line">OPTION( PrintCaches,              OBJC_PRINT_CACHE_SETUP,          &quot;log processing of method caches&quot;)</span><br><span class="line">OPTION( PrintFuture,              OBJC_PRINT_FUTURE_CLASSES,       &quot;log use of future classes for toll-free bridging&quot;)</span><br><span class="line">OPTION( PrintPreopt,              OBJC_PRINT_PREOPTIMIZATION,      &quot;log preoptimization courtesy of dyld shared cache&quot;)</span><br><span class="line">OPTION( PrintCxxCtors,            OBJC_PRINT_CXX_CTORS,            &quot;log calls to C++ ctors and dtors for instance variables&quot;)</span><br><span class="line">OPTION( PrintExceptions,          OBJC_PRINT_EXCEPTIONS,           &quot;log exception handling&quot;)</span><br><span class="line">OPTION( PrintExceptionThrow,      OBJC_PRINT_EXCEPTION_THROW,      &quot;log backtrace of every objc_exception_throw()&quot;)</span><br><span class="line">OPTION( PrintAltHandlers,         OBJC_PRINT_ALT_HANDLERS,         &quot;log processing of exception alt handlers&quot;)</span><br><span class="line">OPTION( PrintReplacedMethods,     OBJC_PRINT_REPLACED_METHODS,     &quot;log methods replaced by category implementations&quot;)</span><br><span class="line">OPTION( PrintDeprecation,         OBJC_PRINT_DEPRECATION_WARNINGS, &quot;warn about calls to deprecated runtime functions&quot;)</span><br><span class="line">OPTION( PrintPoolHiwat,           OBJC_PRINT_POOL_HIGHWATER,       &quot;log high-water marks for autorelease pools&quot;)</span><br><span class="line">OPTION( PrintCustomRR,            OBJC_PRINT_CUSTOM_RR,            &quot;log classes with un-optimized custom retain/release methods&quot;)</span><br><span class="line">OPTION( PrintCustomAWZ,           OBJC_PRINT_CUSTOM_AWZ,           &quot;log classes with un-optimized custom allocWithZone methods&quot;)</span><br><span class="line">OPTION( PrintRawIsa,              OBJC_PRINT_RAW_ISA,              &quot;log classes that require raw pointer isa fields&quot;)</span><br><span class="line"></span><br><span class="line">OPTION( DebugUnload,              OBJC_DEBUG_UNLOAD,               &quot;warn about poorly-behaving bundles when unloaded&quot;)</span><br><span class="line">OPTION( DebugFragileSuperclasses, OBJC_DEBUG_FRAGILE_SUPERCLASSES, &quot;warn about subclasses that may have been broken by subsequent changes to superclasses&quot;)</span><br><span class="line">OPTION( DebugNilSync,             OBJC_DEBUG_NIL_SYNC,             &quot;warn about @synchronized(nil), which does no synchronization&quot;)</span><br><span class="line">OPTION( DebugNonFragileIvars,     OBJC_DEBUG_NONFRAGILE_IVARS,     &quot;capriciously rearrange non-fragile ivars&quot;)</span><br><span class="line">OPTION( DebugAltHandlers,         OBJC_DEBUG_ALT_HANDLERS,         &quot;record more info about bad alt handler use&quot;)</span><br><span class="line">OPTION( DebugMissingPools,        OBJC_DEBUG_MISSING_POOLS,        &quot;warn about autorelease with no pool in place, which may be a leak&quot;)</span><br><span class="line">OPTION( DebugPoolAllocation,      OBJC_DEBUG_POOL_ALLOCATION,      &quot;halt when autorelease pools are popped out of order, and allow heap debuggers to track autorelease pools&quot;)</span><br><span class="line">OPTION( DebugDuplicateClasses,    OBJC_DEBUG_DUPLICATE_CLASSES,    &quot;halt when multiple classes with the same name are present&quot;)</span><br><span class="line">OPTION( DebugDontCrash,           OBJC_DEBUG_DONT_CRASH,           &quot;halt the process by exiting instead of crashing&quot;)</span><br><span class="line"></span><br><span class="line">OPTION( DisableVtables,           OBJC_DISABLE_VTABLES,            &quot;disable vtable dispatch&quot;)</span><br><span class="line">OPTION( DisablePreopt,            OBJC_DISABLE_PREOPTIMIZATION,    &quot;disable preoptimization courtesy of dyld shared cache&quot;)</span><br><span class="line">OPTION( DisableTaggedPointers,    OBJC_DISABLE_TAGGED_POINTERS,    &quot;disable tagged pointer optimization of NSNumber et al.&quot;) </span><br><span class="line">OPTION( DisableTaggedPointerObfuscation, OBJC_DISABLE_TAG_OBFUSCATION,    &quot;disable obfuscation of tagged pointers&quot;)</span><br><span class="line">OPTION( DisableNonpointerIsa,     OBJC_DISABLE_NONPOINTER_ISA,     &quot;disable non-pointer isa fields&quot;)</span><br><span class="line">OPTION( DisableInitializeForkSafety, OBJC_DISABLE_INITIALIZE_FORK_SAFETY, &quot;disable safety checks for +initialize after fork&quot;)</span><br></pre></td></tr></table></figure>
<p>(<em>@Î¿@</em>) å“‡ï½åŒå¤§çš„ä¸€ä¸ªå®åº“ï¼è¿™é‡Œå®šä¹‰äº†å¤§é‡çš„è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ï¼Œå¦‚æœå¼€å¯çš„è¯ï¼Œä¸ä»…æœ‰åŠ©äºæˆ‘ä»¬å­¦ä¹  runtime çš„æºç ï¼Œä¹Ÿå¤§å¤§æ–¹ä¾¿äº†è´Ÿè´£æ€§èƒ½ä¼˜åŒ–çš„åŒå­¦åšä¸€äº›ç»Ÿè®¡çš„è€—æ—¶ç­‰ã€‚</p>
<p>æˆ‘ä»¬å°±ä»¥åˆšåˆšè¯´åˆ°çš„ <code>PrintImageTimes</code> ä¸ºä¾‹ï¼Œå®ƒå¯¹åº”çš„è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ä¸º <code>OBJC_PRINT_IMAGE_TIMES</code> ï¼Œæˆ‘ä»¬åœ¨ Xcode -&gt; Project -&gt; Scheme -&gt; Edit Scheme ä¸­å°†è¯¥ç¯å¢ƒå˜é‡è®¾ä¸º YESï¼š</p>
<p><img src="/2019/05/16/Runtime æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_PrintOption_PrintImageTimes.png" alt="Runtime_PrintOption_PrintImageTimes"></p>
<p>è¿è¡Œç¨‹åºï¼Œå°±å¯ä»¥æ–¹ä¾¿åœ°çœ‹åˆ°å„é˜¶æ®µçš„è€—æ—¶äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">objc[<span class="number">40242</span>]: <span class="number">0.39</span> ms: IMAGE TIMES: first time tasks</span><br><span class="line">objc[<span class="number">40242</span>]: <span class="number">18.40</span> ms: IMAGE TIMES: discover classes</span><br><span class="line">objc[<span class="number">40242</span>]: <span class="number">0.00</span> ms: IMAGE TIMES: remap classes</span><br><span class="line">objc[<span class="number">40242</span>]: <span class="number">100.89</span> ms: IMAGE TIMES: fix up selector references</span><br><span class="line">objc[<span class="number">40242</span>]: <span class="number">0.14</span> ms: IMAGE TIMES: fix up objc_msgSend_fixup</span><br><span class="line">objc[<span class="number">40242</span>]: <span class="number">2.47</span> ms: IMAGE TIMES: discover protocols</span><br><span class="line">objc[<span class="number">40242</span>]: <span class="number">0.67</span> ms: IMAGE TIMES: fix up @protocol references</span><br><span class="line">objc[<span class="number">40242</span>]: <span class="number">3.50</span> ms: IMAGE TIMES: realize non-lazy classes</span><br><span class="line">objc[<span class="number">40242</span>]: <span class="number">0.00</span> ms: IMAGE TIMES: realize future classes</span><br><span class="line">objc[<span class="number">40242</span>]: <span class="number">3.00</span> ms: IMAGE TIMES: discover categories</span><br><span class="line"><span class="number">2019</span><span class="number">-04</span><span class="number">-12</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">02.921120</span>+<span class="number">0800</span> debug-objc[<span class="number">40242</span>:<span class="number">2106148</span>] Hello, World!</span><br><span class="line">Program ended with <span class="built_in">exit</span> code: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/05/16/Runtime æ¸©æ•…è€ŒçŸ¥æ–°/Runtime_Process.png" alt="runtime_process"></p>
<h2 id="initialize"><a href="#initialize" class="headerlink" title="+ initialize"></a>+ initialize</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// ViewController.m</span><br><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line"></span><br><span class="line">@interface SubViewController : ViewController</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation SubViewController</span><br><span class="line"></span><br><span class="line">+ (void)initialize &#123;</span><br><span class="line">    NSLog(@&quot;SubViewController initialize...&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">+ (void)initialize &#123;</span><br><span class="line">    NSLog(@&quot;ViewController initialize...&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    SubViewController *subVC = [[SubViewController alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    </span><br><span class="line">2019-05-15 16:55:02.331135+0800 Test[25870:1727530] ViewController initialize...</span><br><span class="line">2019-05-15 16:55:02.334713+0800 Test[25870:1727530] SubViewController initialize...</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æŠŠå­ç±»ä¸­çš„ <code>+ initialize</code> åˆ æ‰ï¼Œä¼šæ˜¯ä»€ä¹ˆæ ·å‘¢ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// ViewController.m</span><br><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line"></span><br><span class="line">@interface SubViewController : ViewController</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation SubViewController</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">+ (void)initialize &#123;</span><br><span class="line">    NSLog(@&quot;ViewController initialize... self = %@&quot;, self);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    SubViewController *subVC = [[SubViewController alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line">    </span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    </span><br><span class="line">2019-05-15 16:55:50.386359+0800 Test[25907:1728843] ViewController initialize... self = ViewController</span><br><span class="line">2019-05-15 16:55:50.390092+0800 Test[25907:1728843] ViewController initialize... self = SubViewController</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹æºç ï¼Œå¯ä»¥å‘ç° <code>initialize</code> çš„è°ƒç”¨æ˜¯é€šè¿‡ <code>objc_msgSend</code>ï¼Œæ‰€ä»¥å¦‚æœå­ç±»æ²¡æœ‰å®ç°ï¼Œåˆ™ä¼šè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">callInitialize</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ((<span class="keyword">void</span>(*)(Class, SEL))objc_msgSend)(cls, SEL_initialize);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ä¸åŠ åˆ¤æ–­çš„è¯ï¼Œä¸€ä¸ªç±»çš„ initialize å¯èƒ½ä¼šæ‰§è¡Œå¤šæ¬¡ï¼Œè€Œè¿™å¹¶ä¸ä¸€å®šæ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</p>
<p>Qï¼šé‚£ä¹ˆæœ‰çš„åŒå­¦å¯èƒ½ä¼šè¯´ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰å­ç±»ï¼Œæˆ–è€…å­ç±»å®ç°äº† <code>+ initialize</code> ä¸å°±æ²¡é—®é¢˜äº†ä¹ˆï¼Ÿ</p>
<p>Aï¼šâŒã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªğŸŒ°ï¼Œç°åœ¨æˆ‘ä»¬è®©å­ç±»å®ç° <code>+ initialize</code>ï¼Œè¿™æ ·å­ç±»å°±ä¸ä¼šå†è°ƒç”¨çˆ¶ç±»çš„ <code>+initialize</code>äº†ã€‚ç„¶åæˆ‘ä»¬ç»™çˆ¶ç±»æ·»åŠ ä¸€ä¸ª KVOï¼ŒçŒœçŒœç°åœ¨è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">// ViewController.m</span><br><span class="line"></span><br><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line"></span><br><span class="line">@interface SubViewController : ViewController</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation SubViewController</span><br><span class="line"></span><br><span class="line">+ (void)initialize &#123;</span><br><span class="line">    NSLog(@&quot;SubViewController initialize...&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface ViewController ()</span><br><span class="line">@property (nonatomic, strong) SubViewController *subVC;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">+ (void)initialize &#123;</span><br><span class="line">    NSLog(@&quot;ViewController initialize... self = %@&quot;, self);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    self.subVC = [[SubViewController alloc] init];</span><br><span class="line">    </span><br><span class="line">    [self addObserver:self forKeyPath:@&quot;view&quot; options:NSKeyValueObservingOptionNew context:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    [self removeObserver:self forKeyPath:@&quot;view&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line">    </span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    </span><br><span class="line">2019-05-15 16:52:14.792672+0800 Test[25830:1725181] ViewController initialize... self = ViewController</span><br><span class="line">2019-05-15 16:52:14.796562+0800 Test[25830:1725181] SubViewController initialize...</span><br><span class="line">2019-05-15 16:52:14.796983+0800 Test[25830:1725181] ViewController initialize... self = NSKVONotifying_ViewController</span><br></pre></td></tr></table></figure>
<p><code>ViewController</code> çš„ <code>+ initialize</code> è¿˜æ˜¯è¢«è°ƒç”¨äº†ä¸¤æ¬¡ã€‚è¿™æ˜¯å› ä¸º KVO åŠ¨æ€åœ°åˆ›å»ºäº†ä¸€ä¸ªå­ç±»ï¼ˆ<code>NSKVONotifying_ViewController</code>ï¼‰ï¼Œè€Œè¿™ä¸ªå­ç±»ä¸ä¼šé‡å†™ <code>+ initialize</code>ï¼Œæ‰€ä»¥çˆ¶ç±»çš„ <code>+ initialize</code> å°±åˆè¢«è°ƒç”¨äº†ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•è§£å†³å‘¢ï¼ŸğŸ çš„æ–‡æ¡£ä¸­è¯´ï¼šâ€œIf you want to protect yourself from being run multiple times, you can structure your implementation along these lines:â€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (void)initialize &#123;</span><br><span class="line">    if (self == [ClassName self]) &#123;</span><br><span class="line">        // ... do the initialization ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h2><p>Qï¼šå¦‚æœä¸€ä¸ªç±»å®ç°äº† <code>+ load</code> æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªç±»æ²¡æœ‰è¢«ä½¿ç”¨ï¼ˆimportï¼‰ï¼Œé‚£ä¹ˆå®ƒè¿˜ä¼šåœ¨ load_images æ—¶åŠ è½½å˜›ï¼Ÿ<br>Aï¼šä¼šã€‚</p>
<p>Qï¼šå¦‚æœä¸€ä¸ªç±»å®ç°äº† <code>+ load</code> æ–¹æ³•ï¼Œä½†æ˜¯å…·ä½“å®ç°å†…å®¹æ˜¯ç©ºï¼Œé‚£ä¹ˆè¿˜ä¼šåœ¨ load_images æ—¶è¢«åŠ è½½å˜›ï¼Ÿ<br>Aï¼šä¼šã€‚</p>
<p>Qï¼šåŒä¸€ä¸ªé•œåƒä¸­ï¼Œå¤šä¸ªä¸åŒçš„ç±»ã€å¤šä¸ªä¸åŒçš„åˆ†ç±»çš„ <code>+ load</code> è°ƒç”¨é¡ºåºæ˜¯æ€æ ·çš„ï¼Ÿ<br>Aï¼šç¼–è¯‘é¡ºåºã€‚</p>
<p>Qï¼šåŒä¸€ä¸ªé•œåƒä¸­ï¼ŒNonLazyClassA ä¾èµ–äº† NonLazyClassBï¼Œé‚£ä¹ˆå®ƒä»¬çš„ <code>+ load</code> è°ƒç”¨é¡ºåºæ˜¯æ€æ ·çš„ï¼Ÿ<br>Aï¼šè¿˜æ˜¯ç¼–è¯‘é¡ºåºã€‚</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">https://opensource.apple.com/tarballs/objc4/</a></li>
<li><a href="https://developer.apple.com/videos/play/wwdc2016/406" target="_blank" rel="noopener">https://developer.apple.com/videos/play/wwdc2016/406</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008048" target="_blank" rel="noopener">https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008048</a></li>
<li><a href="https://www.mikeash.com/pyblog/friday-qa-2009-05-22-objective-c-class-loading-and-initialization.html" target="_blank" rel="noopener">https://www.mikeash.com/pyblog/friday-qa-2009-05-22-objective-c-class-loading-and-initialization.html</a></li>
<li><a href="http://clang.llvm.org/docs/AutomaticReferenceCounting.html#dealloc" target="_blank" rel="noopener">http://clang.llvm.org/docs/AutomaticReferenceCounting.html#dealloc</a></li>
<li><a href="https://nshipster.com/method-swizzling/" target="_blank" rel="noopener">https://nshipster.com/method-swizzling/</a></li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Runtime/" rel="tag"># Runtime</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/02/SpriteKit å¼€å‘æ¸¸æˆå®æˆ˜â€”â€”ã€ŠOverTheMountainsã€‹/" rel="next" title="SpriteKit å¼€å‘æ¸¸æˆå®æˆ˜â€”â€”ã€ŠOverTheMountainsã€‹">
                <i class="fa fa-chevron-left"></i> SpriteKit å¼€å‘æ¸¸æˆå®æˆ˜â€”â€”ã€ŠOverTheMountainsã€‹
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">iCodeWoods</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">æ—¥å¿—</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">åˆ†ç±»</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">æ ‡ç­¾</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/iCodeWoods" title="GitHub &rarr; https://github.com/iCodeWoods" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Runtime"><span class="nav-number">1.</span> <span class="nav-text">Runtime</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#load"><span class="nav-number">1.1.</span> <span class="nav-text">+ load</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#load-images"><span class="nav-number">1.1.1.</span> <span class="nav-text">load_images</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#hasLoadMethods"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">hasLoadMethods</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#getObjc2NonlazyClassList"><span class="nav-number">1.1.1.1.1.</span> <span class="nav-text">_getObjc2NonlazyClassList</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getDataSection"><span class="nav-number">1.1.1.1.2.</span> <span class="nav-text">getDataSection</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#prepare-load-methods"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">prepare_load_methods</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#schedule-class-load"><span class="nav-number">1.1.1.2.1.</span> <span class="nav-text">schedule_class_load</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#add-category-to-loadable-list"><span class="nav-number">1.1.1.2.2.</span> <span class="nav-text">add_category_to_loadable_list</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#remapClass"><span class="nav-number">1.1.1.2.3.</span> <span class="nav-text">remapClass</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#call-load-methods"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">call_load_methods</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#call-class-loads"><span class="nav-number">1.1.1.3.1.</span> <span class="nav-text">call_class_loads</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Producer-Consumer"><span class="nav-number">1.1.1.4.</span> <span class="nav-text">Producer-Consumer</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#loadMethodLock"><span class="nav-number">1.1.1.4.1.</span> <span class="nav-text">loadMethodLock</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#objc-init"><span class="nav-number">1.2.</span> <span class="nav-text">_objc_init</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dyld-objc-notify-register"><span class="nav-number">1.2.1.</span> <span class="nav-text">_dyld_objc_notify_register</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#map-images"><span class="nav-number">1.2.2.</span> <span class="nav-text">map_images</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#map-images-nolock"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">map_images_nolock</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sel-init"><span class="nav-number">1.2.2.1.1.</span> <span class="nav-text">sel_init</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#arr-init"><span class="nav-number">1.2.2.1.2.</span> <span class="nav-text">arr_init</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#read-images"><span class="nav-number">1.2.2.1.3.</span> <span class="nav-text">_read_images</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#initialize"><span class="nav-number">1.3.</span> <span class="nav-text">+ initialize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QA"><span class="nav-number">1.4.</span> <span class="nav-text">QA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">1.5.</span> <span class="nav-text">References</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">iCodeWoods</span>

  

  
</div>


  <div class="powered-by">ç”± <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨ v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="æ€»è®¿å®¢é‡">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="æ€»è®¿é—®é‡">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>



  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  


  
    

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">



<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: 'd38fffaa5076f5638652',
    clientSecret: '399d468bb9fe3743df10c6e2ee129a9da0af49cb',
    repo: 'iCodeWoods.github.io',
    owner: 'iCodeWoods',
    admin: ['iCodeWoods'],
    id: md5(location.pathname),
    
      language: window.navigator.language || window.navigator.userLanguage,
    
    distractionFreeMode: 'true'
  });
  gitalk.render('gitalk-container');
</script>

  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
